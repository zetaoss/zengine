name: auto-pr

on:
  push:
    branches:
      - "**"

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: auto-pr-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  create-or-update-pr:
    if: github.ref_type == 'branch'
    runs-on: ubuntu-latest
    steps:
      - name: Create or update PR
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.AUTO_PR_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const sleep = (ms) => new Promise((resolve) => setTimeout(resolve, ms));

            async function retry(times, delayMs, fn) {
              let lastErr;
              for (let i = 0; i < times; i++) {
                try {
                  return await fn();
                } catch (e) {
                  lastErr = e;
                  // permission/validation errors are terminal for this action
                  if (e?.status === 403 || e?.status === 422) throw e;
                  if (i < times - 1) await sleep(delayMs);
                }
              }
              throw lastErr;
            }

            async function ensureAssignee(issueNumber, assignee) {
              const issue = await github.rest.issues.get({
                owner,
                repo,
                issue_number: issueNumber
              });
              const alreadyAssigned = issue.data.assignees?.some((x) => x.login === assignee) === true;
              if (alreadyAssigned) return;

              await github.rest.issues.addAssignees({
                owner,
                repo,
                issue_number: issueNumber,
                assignees: [assignee]
              });
            }
            const headBranch = context.ref.replace('refs/heads/', '');
            const baseBranch = context.payload.repository.default_branch;

            if (!headBranch || headBranch === baseBranch) {
              core.info(`Skip: head=${headBranch}, base=${baseBranch}`);
              return;
            }

            const headCommitMessage = context.payload.head_commit?.message;
            if (!headCommitMessage) {
              core.info('Skip: head_commit is null (branch deletion or non-standard push event).');
              return;
            }

            const prTitle = headCommitMessage
              .split('\n')[0]
              .trim();
            const prBody = [
              'This PR was created automatically on push.',
              '',
              `- Head: \`${headBranch}\``,
              `- Base: \`${baseBranch}\``,
              `- Commit: ${context.sha}`
            ].join('\n');

            const existing = await github.rest.pulls.list({
              owner,
              repo,
              state: 'open',
              head: `${owner}:${headBranch}`,
              base: baseBranch,
              per_page: 1
            });

            if (existing.data.length > 0) {
              const pr = existing.data[0];
              await github.rest.pulls.update({
                owner,
                repo,
                pull_number: pr.number,
                title: prTitle,
                body: prBody
              });
              try {
                await retry(3, 5000, () => ensureAssignee(pr.number, context.actor));
              } catch (e) {
                core.warning(`Assignee step skipped (status=${e?.status ?? 'unknown'})`);
              }
              core.info(`Updated PR #${pr.number}`);
              return;
            }

            const created = await github.rest.pulls.create({
              owner,
              repo,
              title: prTitle,
              head: headBranch,
              base: baseBranch,
              body: prBody
            });
            try {
              await retry(3, 5000, () => ensureAssignee(created.data.number, context.actor));
            } catch (e) {
              core.warning(`Assignee step skipped (status=${e?.status ?? 'unknown'})`);
            }
            core.info(`Created PR #${created.data.number}`);
