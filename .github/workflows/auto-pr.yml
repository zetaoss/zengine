name: auto-pr

on:
  push:
    branches:
      - "**"

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: auto-pr-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  create-or-update-pr:
    if: github.ref_type == 'branch'
    runs-on: ubuntu-latest
    steps:
      - name: Generate app token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Create or update PR
        uses: actions/github-script@v8
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const headBranch = context.ref.replace('refs/heads/', '');
            const baseBranch = context.payload.repository.default_branch;

            if (!headBranch || headBranch === baseBranch) {
              core.info(`Skip: head=${headBranch}, base=${baseBranch}`);
              return;
            }

            const prTitle = context.payload.head_commit.message
              .split('\n')[0]
              .trim();
            const prBody = [
              'This PR was created automatically on push.',
              '',
              `- Head: \`${headBranch}\``,
              `- Base: \`${baseBranch}\``,
              `- Commit: ${context.sha}`
            ].join('\n');

            const existing = await github.rest.pulls.list({
              owner,
              repo,
              state: 'open',
              head: `${owner}:${headBranch}`,
              base: baseBranch,
              per_page: 1
            });

            if (existing.data.length > 0) {
              const pr = existing.data[0];
              await github.rest.pulls.update({
                owner,
                repo,
                pull_number: pr.number,
                title: prTitle,
                body: prBody
              });
              core.info(`Updated PR #${pr.number}`);
              return;
            }

            const created = await github.rest.pulls.create({
              owner,
              repo,
              title: prTitle,
              head: headBranch,
              base: baseBranch,
              body: prBody
            });
            core.info(`Created PR #${created.data.number}`);
